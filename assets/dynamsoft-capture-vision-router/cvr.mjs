/*!
 * Dynamsoft JavaScript Library
 * @product Dynamsoft Capture Vision Router JS Edition
 * @website http://www.dynamsoft.com
 * @copyright Copyright 2024, Dynamsoft Corporation
 * @author Dynamsoft
 * @version "2.2.30"
 * @fileoverview Dynamsoft JavaScript Library for Capture Vision
 * More info on cvr JS: https://www.dynamsoft.com/capture-vision/docs/web/programming/javascript/api-reference/capture-vision-router/capture-vision-router-module.html
 */
import{getNextTaskID as e,mapTaskCallBack as t,worker as s,engineResourcePaths as i,workerAutoResources as a,mapPackageRegister as r,compareVersion as n,innerVersions as o,EnumCapturedResultItemType as c,CoreModule as d,loadWasm as l,EnumImagePixelFormat as u,EnumColourChannelUsageType as _,_isDSImageData as m,requestResource as h,bSupportBigInt as g,EnumIntermediateResultUnitType as R}from"dynamsoft-core";const I=e=>e&&"object"==typeof e&&"function"==typeof e.then;class p extends Promise{constructor(e){let t,s;super(((e,i)=>{t=e,s=i})),this._s="pending",this.resolve=e=>{this.isPending&&(I(e)?this.task=e:(this._s="fulfilled",t(e)))},this.reject=e=>{this.isPending&&(this._s="rejected",s(e))},this.task=e}get status(){return this._s}get isPending(){return"pending"===this._s}get isFulfilled(){return"fulfilled"===this._s}get isRejected(){return"rejected"===this._s}get task(){return this._task}set task(e){let t;this._task=e,I(e)?t=e:"function"==typeof e&&(t=new Promise(e)),t&&(async()=>{try{const s=await t;e===this._task&&this.resolve(s)}catch(t){e===this._task&&this.reject(t)}})()}get isEmpty(){return null==this._task}}class v{constructor(e){this._cvr=e}async getMaxBufferedItems(){return await new Promise(((i,a)=>{let r=e();t[r]=async e=>{if(e.success)return i(e.count);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,a(t)}},s.postMessage({type:"cvr_getMaxBufferedItems",id:r,instanceID:this._cvr._instanceID})}))}async setMaxBufferedItems(i){return await new Promise(((a,r)=>{let n=e();t[n]=async e=>{if(e.success)return a();{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},s.postMessage({type:"cvr_setMaxBufferedItems",id:n,instanceID:this._cvr._instanceID,body:{count:i}})}))}async getBufferedCharacterItemSet(){return await new Promise(((i,a)=>{let r=e();t[r]=async e=>{if(e.success)return i(e.itemSet);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,a(t)}},s.postMessage({type:"cvr_getBufferedCharacterItemSet",id:r,instanceID:this._cvr._instanceID})}))}}var f={onTaskResultsReceived:!1,onTaskResultsReceivedForDce:!1,onPredetectedRegionsReceived:!1,onLocalizedBarcodesReceived:!1,onDecodedBarcodesReceived:!1,onLocalizedTextLinesReceived:!1,onRecognizedTextLinesReceived:!1,onDetectedQuadsReceived:!1,onNormalizedImagesReceived:!1,onColourImageUnitReceived:!1,onScaledDownColourImageUnitReceived:!1,onGrayscaleImageUnitReceived:!1,onTransformedGrayscaleImageUnitReceived:!1,onEnhancedGrayscaleImageUnitReceived:!1,onBinaryImageUnitReceived:!1,onTextureDetectionResultUnitReceived:!1,onTextureRemovedGrayscaleImageUnitReceived:!1,onTextureRemovedBinaryImageUnitReceived:!1,onContoursUnitReceived:!1,onLineSegmentsUnitReceived:!1,onTextZonesUnitReceived:!1,onTextRemovedBinaryImageUnitReceived:!1,onLongLinesUnitReceived:!1,onCornersUnitReceived:!1,onCandidateQuadEdgesUnitReceived:!1,onCandidateBarcodeZonesUnitReceived:!1,onScaledUpBarcodeImageUnitReceived:!1,onDeformationResistedBarcodeImageUnitReceived:!1,onComplementedBarcodeImageUnitReceived:!1,onShortLinesUnitReceived:!1};const T=(e,t)=>{for(let e in t._irrRegistryState)t._irrRegistryState[e]=!1;for(let s of e._intermediateResultReceiverSet)if(s.isDce)t._irrRegistryState.onTaskResultsReceivedForDce=!0;else for(let e in s)t._irrRegistryState[e]||(t._irrRegistryState[e]=!!s[e])};class E{constructor(e){this._irrRegistryState=f,this._cvr=e}async addResultReceiver(i){if("object"!=typeof i)throw new Error("Invalid receiver.");this._cvr._intermediateResultReceiverSet.add(i),T(this._cvr,this);let a=-1,r={};if(!i.isDce){if(!i._observedResultUnitTypes||!i._observedTaskMap)throw new Error("Invalid Intermediate Result Receiver.");a=i._observedResultUnitTypes,i._observedTaskMap.forEach(((e,t)=>{r[t]=e})),i._observedTaskMap.clear()}return await new Promise(((i,n)=>{let o=e();t[o]=async e=>{if(e.success)return i();{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,n(t)}},s.postMessage({type:"cvr_setIrrRegistry",id:o,instanceID:this._cvr._instanceID,body:{receiverObj:this._irrRegistryState,observedResultUnitTypes:String(a),observedTaskMap:r}})}))}async removeResultReceiver(i){return this._cvr._intermediateResultReceiverSet.delete(i),T(this._cvr,this),await new Promise(((i,a)=>{let r=e();t[r]=async e=>{if(e.success)return i();{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,a(t)}},s.postMessage({type:"cvr_setIrrRegistry",id:r,instanceID:this._cvr._instanceID,body:{receiverObj:this._irrRegistryState}})}))}getOriginalImage(){return this._cvr._dsImage}}const y="undefined"==typeof self,S=(()=>{if(!y&&document.currentScript){let e=document.currentScript.src,t=e.indexOf("?");if(-1!=t)e=e.substring(0,t);else{let t=e.indexOf("#");-1!=t&&(e=e.substring(0,t))}return e.substring(0,e.lastIndexOf("/")+1)}return"./"})(),D=e=>{if(null==e&&(e="./"),y);else{let t=document.createElement("a");t.href=e,e=t.href}return e.endsWith("/")||(e+="/"),e};var b;null==i.cvr&&(i.cvr=S),a.cvr={js:!0,wasm:!0,deps:["license","dip"]},r.cvr={};const w="1.2.10";"string"!=typeof i.std&&n(i.std.version,w)<0&&(i.std={version:w,path:D(S+`../../dynamsoft-capture-vision-std@${w}/dist/`)});const C="2.2.30";(!i.dip||"string"!=typeof i.dip&&n(i.dip.version,C)<0)&&(i.dip={version:C,path:D(S+`../../dynamsoft-image-processing@${C}/dist/`)});class O{static getVersion(){return this._version}}var L,U;function k(e,t){if(e&&e.location){const s=e.location.points;for(let e of s)e.x=e.x/t,e.y=e.y/t;k(e.referencedItem,t)}}O._version=`2.2.30(Worker: ${null===(b=o.cvr)||void 0===b?void 0:b.worker}, Wasm: loading...`,function(e){e[e.ISS_BUFFER_EMPTY=0]="ISS_BUFFER_EMPTY",e[e.ISS_EXHAUSTED=1]="ISS_EXHAUSTED"}(L||(L={})),function(e){e[e.IRUT_NULL=0]="IRUT_NULL",e[e.IRUT_COLOUR_IMAGE=1]="IRUT_COLOUR_IMAGE",e[e.IRUT_SCALED_DOWN_COLOUR_IMAGE=2]="IRUT_SCALED_DOWN_COLOUR_IMAGE",e[e.IRUT_GRAYSCALE_IMAGE=4]="IRUT_GRAYSCALE_IMAGE",e[e.IRUT_TRANSOFORMED_GRAYSCALE_IMAGE=8]="IRUT_TRANSOFORMED_GRAYSCALE_IMAGE",e[e.IRUT_ENHANCED_GRAYSCALE_IMAGE=16]="IRUT_ENHANCED_GRAYSCALE_IMAGE",e[e.IRUT_PREDETECTED_REGIONS=32]="IRUT_PREDETECTED_REGIONS",e[e.IRUT_BINARY_IMAGE=64]="IRUT_BINARY_IMAGE",e[e.IRUT_TEXTURE_DETECTION_RESULT=128]="IRUT_TEXTURE_DETECTION_RESULT",e[e.IRUT_TEXTURE_REMOVED_GRAYSCALE_IMAGE=256]="IRUT_TEXTURE_REMOVED_GRAYSCALE_IMAGE",e[e.IRUT_TEXTURE_REMOVED_BINARY_IMAGE=512]="IRUT_TEXTURE_REMOVED_BINARY_IMAGE",e[e.IRUT_CONTOURS=1024]="IRUT_CONTOURS",e[e.IRUT_LINE_SEGMENTS=2048]="IRUT_LINE_SEGMENTS",e[e.IRUT_TEXT_ZONES=4096]="IRUT_TEXT_ZONES",e[e.IRUT_TEXT_REMOVED_BINARY_IMAGE=8192]="IRUT_TEXT_REMOVED_BINARY_IMAGE",e[e.IRUT_CANDIDATE_BARCODE_ZONES=16384]="IRUT_CANDIDATE_BARCODE_ZONES",e[e.IRUT_LOCALIZED_BARCODES=32768]="IRUT_LOCALIZED_BARCODES",e[e.IRUT_SCALED_UP_BARCODE_IMAGE=65536]="IRUT_SCALED_UP_BARCODE_IMAGE",e[e.IRUT_DEFORMATION_RESISTED_BARCODE_IMAGE=131072]="IRUT_DEFORMATION_RESISTED_BARCODE_IMAGE",e[e.IRUT_COMPLEMENTED_BARCODE_IMAGE=262144]="IRUT_COMPLEMENTED_BARCODE_IMAGE",e[e.IRUT_DECODED_BARCODES=524288]="IRUT_DECODED_BARCODES",e[e.IRUT_LONG_LINES=1048576]="IRUT_LONG_LINES",e[e.IRUT_CORNERS=2097152]="IRUT_CORNERS",e[e.IRUT_CANDIDATE_QUAD_EDGES=4194304]="IRUT_CANDIDATE_QUAD_EDGES",e[e.IRUT_DETECTED_QUADS=8388608]="IRUT_DETECTED_QUADS",e[e.IRUT_LOCALIZED_TEXT_LINES=16777216]="IRUT_LOCALIZED_TEXT_LINES",e[e.IRUT_RECOGNIZED_TEXT_LINES=33554432]="IRUT_RECOGNIZED_TEXT_LINES",e[e.IRUT_NORMALIZED_IMAGES=67108864]="IRUT_NORMALIZED_IMAGES",e[e.IRUT_SHORT_LINES=134217728]="IRUT_SHORT_LINES",e[e.IRUT_ALL=134217727]="IRUT_ALL"}(U||(U={}));class A{constructor(){this.maxCvsSideLength=["iPhone","Android","HarmonyOS"].includes(d.browserInfo.OS)?2048:4096,this._isa=null,this._dsImage=null,this._instanceID=void 0,this._bPauseScan=!0,this._bNeedOutputOriginalImage=!1,this._canvas=null,this._resultReceiverSet=new Set,this._isaStateListenerSet=new Set,this._resultFilterSet=new Set,this._intermediateResultReceiverSet=new Set,this._intermediateResultManager=null,this._bufferdItemsManager=null,this._bOpenDetectVerify=!1,this._bOpenNormalizeVerify=!1,this._bOpenBarcodeVerify=!1,this._bOpenLabelVerify=!1,this._minImageCaptureInterval=0,this._averageProcessintTimeArray=[],this._averageFetchImageTimeArray=[],this._currentSettings=null,this._averageTime=999,this._compressRate=0,this._dynamsoft=!1,this.captureInParallel=!0,this.bDestroyed=!1,this._singleFrameModeCallbackBind=this._singleFrameModeCallback.bind(this),this._promiseStartScan=null}get disposed(){return this.bDestroyed}static async createInstance(){if(!r.license)throw Error("Module `license` is not existed.");await r.license.dynamsoft(),await l(["cvr"]);const i=new A,a=new p;let n=e();return t[n]=async e=>{var t;if(e.success)i._instanceID=e.instanceID,i._currentSettings=JSON.parse(e.outputSettings),O._version=`2.2.30(Worker: ${null===(t=o.cvr)||void 0===t?void 0:t.worker}, Wasm: ${e.version})`,0===d.bSupportDce4Module&&(i._intermediateResultManager=i.getIntermediateResultManager(!0)),a.resolve(i);else{const t=Error(e.message);e.stack&&(t.stack=e.stack),a.reject(t)}},s.postMessage({type:"cvr_createInstance",id:n}),a}async _singleFrameModeCallback(e){this._isa.getCameraView().setScanLaserVisible(!0);for(let t of this._resultReceiverSet)this._bNeedOutputOriginalImage&&t.onOriginalImageResultReceived&&t.onOriginalImageResultReceived({imageData:e});const t={bytes:new Uint8Array(e.bytes),width:e.width,height:e.height,stride:e.stride,format:e.format,tag:e.tag};this._templateName||(this._templateName=this._currentSettings.CaptureVisionTemplates[0].Name);const s=await this.capture(t,this._templateName);s.originalImageTag=e.tag;for(let e of this._resultReceiverSet)e.isDce&&e.onCapturedResultReceived(s,{isDetectVerifyOpen:!1,isNormalizeVerifyOpen:!1,isBarcodeVerifyOpen:!1,isLabelVerifyOpen:!1});const i={originalImageHashId:s.originalImageHashId,originalImageTag:s.originalImageTag,errorCode:s.errorCode,errorString:s.errorString};for(let t of this._resultReceiverSet)if(t.onDecodedBarcodesReceived&&s.barcodeResultItems&&t.onDecodedBarcodesReceived(Object.assign(Object.assign({},i),{barcodeResultItems:s.barcodeResultItems})),t.onRecognizedTextLinesReceived&&s.textLineResultItems&&t.onRecognizedTextLinesReceived(Object.assign(Object.assign({},i),{textLineResultItems:s.textLineResultItems})),t.onDetectedQuadsReceived&&s.detectedQuadResultItems&&t.onDetectedQuadsReceived(Object.assign(Object.assign({},i),{detectedQuadResultItems:s.detectedQuadResultItems})),t.onNormalizedImagesReceived&&s.normalizedImageResultItems&&t.onNormalizedImagesReceived(Object.assign(Object.assign({},i),{normalizedImageResultItems:s.normalizedImageResultItems})),t.onParsedResultsReceived&&s.parsedResultItems&&t.onParsedResultsReceived(Object.assign(Object.assign({},i),{parsedResultItems:s.parsedResultItems})),t.onCapturedResultReceived&&!t.isDce){if(this._bNeedOutputOriginalImage){const t=s.items.findIndex((e=>1===e.type));-1!==t&&(s.items[t].imageData=e)}t.onCapturedResultReceived(s)}}setInput(e){if(this._checkIsDisposed(),e){if(this._isa=e,e.isCameraEnhancer){this._intermediateResultManager&&(this._isa._intermediateResultReceiver.isDce=!0,this._intermediateResultManager.addResultReceiver(this._isa._intermediateResultReceiver));const e=this._isa.getCameraView();if(e){const t=e._capturedResultReceiver;t.isDce=!0,this._resultReceiverSet.add(t)}}}else this._isa=null}getInput(){return this._isa}addImageSourceStateListener(e){if(this._checkIsDisposed(),"object"!=typeof e)return console.warn("Invalid ISA state listener.");e&&Object.keys(e)&&this._isaStateListenerSet.add(e)}removeImageSourceStateListener(e){return this._checkIsDisposed(),this._isaStateListenerSet.delete(e)}addResultReceiver(e){if(this._checkIsDisposed(),"object"!=typeof e)throw new Error("Invalid receiver.");e&&Object.keys(e).length&&(this._resultReceiverSet.add(e),this._setCrrRegistry())}removeResultReceiver(e){this._checkIsDisposed(),this._resultReceiverSet.delete(e),this._setCrrRegistry()}async _setCrrRegistry(){const i={onCapturedResultReceived:!1,onDecodedBarcodesReceived:!1,onRecognizedTextLinesReceived:!1,onDetectedQuadsReceived:!1,onNormalizedImagesReceived:!1,onParsedResultsReceived:!1};for(let e of this._resultReceiverSet)e.isDce||(i.onCapturedResultReceived=!!e.onCapturedResultReceived,i.onDecodedBarcodesReceived=!!e.onDecodedBarcodesReceived,i.onRecognizedTextLinesReceived=!!e.onRecognizedTextLinesReceived,i.onDetectedQuadsReceived=!!e.onDetectedQuadsReceived,i.onNormalizedImagesReceived=!!e.onNormalizedImagesReceived,i.onParsedResultsReceived=!!e.onParsedResultsReceived);const a=new p;let r=e();return t[r]=async e=>{if(e.success)a.resolve();else{let t=new Error(e.message);t.stack=e.stack+"\n"+t.stack,a.reject()}},s.postMessage({type:"cvr_setCrrRegistry",id:r,instanceID:this._instanceID,body:{receiver:JSON.stringify(i)}}),a}async addResultFilter(e){if(this._checkIsDisposed(),"object"!=typeof e)return console.warn("Invalid filter.");if(e&&Object.keys(e)){this._resultFilterSet.add(e),this._handleFilterSwitch();for(let e of this._resultFilterSet)await this._enableResultCrossVerification(e.verificationEnabled),await this._enableResultDeduplication(e.duplicateFilterEnabled),await this._setDuplicateForgetTime(e.duplicateForgetTime)}}async removeResultFilter(e){this._checkIsDisposed(),this._resultFilterSet.delete(e),this._handleFilterSwitch();for(let e of this._resultFilterSet)await this._enableResultCrossVerification(e.verificationEnabled),await this._enableResultDeduplication(e.duplicateFilterEnabled),await this._setDuplicateForgetTime(e.duplicateForgetTime)}_handleFilterSwitch(){this._bOpenBarcodeVerify=!1,this._bOpenLabelVerify=!1,this._bOpenDetectVerify=!1,this._bOpenNormalizeVerify=!1;for(let e of this._resultFilterSet)e.isResultCrossVerificationEnabled(c.CRIT_BARCODE)&&(this._bOpenBarcodeVerify=!0),e.isResultCrossVerificationEnabled(c.CRIT_TEXT_LINE)&&(this._bOpenLabelVerify=!0),e.isResultCrossVerificationEnabled(c.CRIT_DETECTED_QUAD)&&(this._bOpenDetectVerify=!0),e.isResultCrossVerificationEnabled(c.CRIT_NORMALIZED_IMAGE)&&(this._bOpenNormalizeVerify=!0)}async startCapturing(a){var n,o;if(this._checkIsDisposed(),!this._bPauseScan)return;if(!this._isa)throw new Error("'ImageSourceAdapter' is not set. call 'setInput' before 'startCapturing'");a||(a=this._currentSettings.CaptureVisionTemplates[0].Name);const c=await this.containsTask(a);if(await l(c),c.includes("dlr")&&!(null===(n=r.dlr)||void 0===n?void 0:n.bLoadConfusableCharsData)&&await(null===(o=r.dlr)||void 0===o?void 0:o.loadRecognitionData("ConfusableChars",i.dlr)),this._isa.isCameraEnhancer&&(c.includes("ddn")?this._isa.setPixelFormat(u.IPF_ABGR_8888):this._isa.setPixelFormat(u.IPF_GRAYSCALED)),void 0!==this._isa.singleFrameMode&&"disabled"!==this._isa.singleFrameMode)return this._templateName=a,void this._isa.on("singleFrameAcquired",this._singleFrameModeCallbackBind);return this._isa.getColourChannelUsageType()===_.CCUT_AUTO&&this._isa.setColourChannelUsageType(c.includes("ddn")?_.CCUT_FULL_CHANNEL:_.CCUT_Y_CHANNEL_ONLY),this._promiseStartScan&&this._promiseStartScan.isPending?this._promiseStartScan:(this._promiseStartScan=new p(((i,r)=>{if(this.disposed)return;let n=e();t[n]=async e=>{if(this._promiseStartScan&&!this._promiseStartScan.isFulfilled){if(!e.success){let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}for(let e of this._resultFilterSet)await this.addResultFilter(e);this._bPauseScan=!1,this._bNeedOutputOriginalImage=e.bNeedOutputOriginalImage,this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((async()=>{-1!==this._minImageCaptureInterval&&this._isa.startFetching(),this._loopReadVideo(a),i()}),0),this._isa.isCameraEnhancer&&this._isa.getCameraView().setScanLaserVisible(!0)}},s.postMessage({type:"cvr_startCapturing",id:n,instanceID:this._instanceID,body:{templateName:a}})})),await this._promiseStartScan)}stopCapturing(){this._checkIsDisposed(),this._isa&&(this._isa.isCameraEnhancer&&(this._isa.getCameraView().setScanLaserVisible(!1),void 0!==this._isa.singleFrameMode&&"disabled"!==this._isa.singleFrameMode)?this._isa.off("singleFrameAcquired",this._singleFrameModeCallbackBind):(this._isa.stopFetching(),this._clearVerifyList(),this._averageProcessintTimeArray=[],this._averageTime=999,this._bPauseScan=!0,this._promiseStartScan=null,this._isa.setColourChannelUsageType(_.CCUT_AUTO)))}async _clearVerifyList(){let i=e();const a=new p;return t[i]=async e=>{if(e.success)return a.resolve();{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,a.reject(t)}},s.postMessage({type:"cvr_clearVerifyList",id:i,instanceID:this._instanceID}),a}async _getIntermediateResult(){this._checkIsDisposed();let i=e();const a=new p;return t[i]=async e=>{if(e.success)a.resolve(e.result);else{let t=new Error(e.message);t.stack=e.stack+"\n"+t.stack,a.reject(t)}},s.postMessage({type:"cvr_getIntermediateResult",id:i,instanceID:this._instanceID}),a}async containsTask(i){return this._checkIsDisposed(),await new Promise(((a,r)=>{let n=e();t[n]=async e=>{if(e.success)return a(JSON.parse(e.tasks));{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},s.postMessage({type:"cvr_containsTask",id:n,instanceID:this._instanceID,body:{templateName:i}})}))}async _loopReadVideo(e){if(this._dynamsoft=!0,this.disposed||this._bPauseScan)return;if(this._isa.isBufferEmpty())if(this._isa.hasNextImageToFetch())for(let e of this._isaStateListenerSet)e.onImageSourceStateReceived&&e.onImageSourceStateReceived(L.ISS_BUFFER_EMPTY);else if(!this._isa.hasNextImageToFetch())for(let e of this._isaStateListenerSet)e.onImageSourceStateReceived&&e.onImageSourceStateReceived(L.ISS_EXHAUSTED);if(-1===this._minImageCaptureInterval||this._isa.isBufferEmpty())try{this._isa.isBufferEmpty()&&A._onLog&&A._onLog("buffer is empty so fetch image"),A._onLog&&A._onLog(`DCE: start fetching a frame: ${Date.now()}`),this._dsImage=this._isa.fetchImage(),A._onLog&&A._onLog(`DCE: finish fetching a frame: ${Date.now()}`),this._isa.setImageFetchInterval(this._averageTime)}catch(t){return void this._reRunCurrnetFunc(e)}else if(this._isa.setImageFetchInterval(this._averageTime-(this._dsImage&&this._dsImage.tag?this._dsImage.tag.timeSpent:0)),this._dsImage=this._isa.getImage(),this._dsImage.tag&&Date.now()-this._dsImage.tag.timeStamp>200)return void this._reRunCurrnetFunc(e);if(!this._dsImage)return void this._reRunCurrnetFunc(e);for(let e of this._resultReceiverSet)this._bNeedOutputOriginalImage&&e.onOriginalImageResultReceived&&e.onOriginalImageResultReceived({imageData:this._dsImage});const t=Date.now();this._captureDsimage(this._dsImage,e).then((async s=>{if(A._onLog&&A._onLog("no js handle time: "+(Date.now()-t)),this._bPauseScan)return void this._reRunCurrnetFunc(e);s.originalImageTag=this._dsImage.tag?this._dsImage.tag:null;for(let e of this._resultReceiverSet)if(e.isDce){const t=Date.now();if(e.onCapturedResultReceived(s,{isDetectVerifyOpen:this._bOpenDetectVerify,isNormalizeVerifyOpen:this._bOpenNormalizeVerify,isBarcodeVerifyOpen:this._bOpenBarcodeVerify,isLabelVerifyOpen:this._bOpenLabelVerify}),A._onLog){const e=Date.now()-t;e>10&&A._onLog(`draw result time: ${e}`)}}const i={originalImageHashId:s.originalImageHashId,originalImageTag:s.originalImageTag,errorCode:s.errorCode,errorString:s.errorString};for(let e of this._resultReceiverSet)e.onDecodedBarcodesReceived&&s.barcodeResultItems&&e.onDecodedBarcodesReceived(Object.assign(Object.assign({},i),{barcodeResultItems:s.barcodeResultItems.filter((e=>!e.isFilter))})),e.onRecognizedTextLinesReceived&&s.textLineResultItems&&e.onRecognizedTextLinesReceived(Object.assign(Object.assign({},i),{textLineResultItems:s.textLineResultItems.filter((e=>!e.isFilter))})),e.onDetectedQuadsReceived&&s.detectedQuadResultItems&&e.onDetectedQuadsReceived(Object.assign(Object.assign({},i),{detectedQuadResultItems:s.detectedQuadResultItems.filter((e=>!e.isFilter))})),e.onNormalizedImagesReceived&&s.normalizedImageResultItems&&e.onNormalizedImagesReceived(Object.assign(Object.assign({},i),{normalizedImageResultItems:s.normalizedImageResultItems.filter((e=>!e.isFilter))})),e.onParsedResultsReceived&&s.parsedResultItems&&e.onParsedResultsReceived(Object.assign(Object.assign({},i),{parsedResultItems:s.parsedResultItems.filter((e=>!e.isFilter))})),e.onCapturedResultReceived&&!e.isDce&&(s.items=s.items.filter((e=>!e.isFilter)),s.barcodeResultItems&&(s.barcodeResultItems=s.barcodeResultItems.filter((e=>!e.isFilter))),s.textLineResultItems&&(s.textLineResultItems=s.textLineResultItems.filter((e=>!e.isFilter))),s.detectedQuadResultItems&&(s.detectedQuadResultItems=s.detectedQuadResultItems.filter((e=>!e.isFilter))),s.normalizedImageResultItems&&(s.normalizedImageResultItems=s.normalizedImageResultItems.filter((e=>!e.isFilter))),s.parsedResultItems&&(s.parsedResultItems=s.parsedResultItems.filter((e=>!e.isFilter))),e.onCapturedResultReceived(s));const a=Date.now();if(this._minImageCaptureInterval>-1&&(5===this._averageProcessintTimeArray.length&&this._averageProcessintTimeArray.shift(),5===this._averageFetchImageTimeArray.length&&this._averageFetchImageTimeArray.shift(),this._averageProcessintTimeArray.push(Date.now()-t),this._averageFetchImageTimeArray.push(this._dsImage&&this._dsImage.tag?this._dsImage.tag.timeSpent:0),this._averageTime=Math.min(...this._averageProcessintTimeArray)-Math.max(...this._averageFetchImageTimeArray),this._averageTime=this._averageTime>0?this._averageTime:0,A._onLog&&(A._onLog(`minImageCaptureInterval: ${this._minImageCaptureInterval}`),A._onLog(`averageProcessintTimeArray: ${this._averageProcessintTimeArray}`),A._onLog(`averageFetchImageTimeArray: ${this._averageFetchImageTimeArray}`),A._onLog(`averageTime: ${this._averageTime}`))),A._onLog){const e=Date.now()-a;e>10&&A._onLog(`fetch image calculate time: ${e}`)}A._onLog&&A._onLog(`time finish decode: ${Date.now()}`),A._onLog&&A._onLog("main time: "+(Date.now()-t)),A._onLog&&A._onLog("===================================================="),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._minImageCaptureInterval>0&&this._minImageCaptureInterval>=this._averageTime?this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo(e)}),this._minImageCaptureInterval-this._averageTime):this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo(e)}),Math.max(this._minImageCaptureInterval,0))})).catch((t=>{this._isa.stopFetching(),this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this._isa.startFetching(),this._loopReadVideo(e)}),Math.max(this._minImageCaptureInterval,1e3)),"platform error"!==t.message&&setTimeout((()=>{throw t}),0)}))}_reRunCurrnetFunc(e){this._loopReadVideoTimeoutId&&clearTimeout(this._loopReadVideoTimeoutId),this._loopReadVideoTimeoutId=setTimeout((()=>{this._loopReadVideo(e)}),0)}async capture(e,t){var s,a;this._checkIsDisposed(),t||(t=this._currentSettings.CaptureVisionTemplates[0].Name);const n=await this.containsTask(t);let o;if(await l(n),n.includes("dlr")&&!(null===(s=r.dlr)||void 0===s?void 0:s.bLoadConfusableCharsData)&&await(null===(a=r.dlr)||void 0===a?void 0:a.loadRecognitionData("ConfusableChars",i.dlr)),this._dynamsoft=!1,m(e))o=await this._captureDsimage(e,t);else if("string"==typeof e)o="data:image/"==e.substring(0,11)?await this._captureBase64(e,t):await this._captureUrl(e,t);else if(e instanceof Blob)o=await this._captureBlob(e,t);else if(e instanceof HTMLImageElement)o=await this._captureImage(e,t);else if(e instanceof HTMLCanvasElement)o=await this._captureCanvas(e,t);else{if(!(e instanceof HTMLVideoElement))throw new TypeError("'capture(imageOrFile, templateName)': Type of 'imageOrFile' should be 'DSImageData', 'Url', 'Base64', 'Blob', 'HTMLImageElement', 'HTMLCanvasElement', 'HTMLVideoElement'.");o=await this._captureVideo(e,t)}return o}async _captureDsimage(e,t){return await this._captureInWorker(e,t)}async _captureUrl(e,t){let s=await h(e,"blob");return await this._captureBlob(s,t)}async _captureBase64(e,t){e=e.substring(e.indexOf(",")+1);let s=atob(e),i=s.length,a=new Uint8Array(i);for(;i--;)a[i]=s.charCodeAt(i);return await this._captureBlob(new Blob([a]),t)}async _captureBlob(e,t){let s=null,i=null;if("undefined"!=typeof createImageBitmap)try{s=await createImageBitmap(e)}catch(e){}s||(i=await async function(e){return await new Promise(((t,s)=>{let i=URL.createObjectURL(e),a=new Image;a.src=i,a.onload=()=>{URL.revokeObjectURL(a.dbrObjUrl),t(a)},a.onerror=e=>{s(new Error("Can't convert blob to image : "+(e instanceof Event?e.type:e)))}}))}(e));let a=await this._captureImage(s||i,t);return s&&s.close(),a}async _captureImage(e,t){let s,i,a=e instanceof HTMLImageElement?e.naturalWidth:e.width,r=e instanceof HTMLImageElement?e.naturalHeight:e.height,n=Math.max(a,r);n>this.maxCvsSideLength?(this._compressRate=this.maxCvsSideLength/n,s=Math.round(a*this._compressRate),i=Math.round(r*this._compressRate)):(s=a,i=r),this._canvas||(this._canvas=document.createElement("canvas"));const o=this._canvas;o.width===s&&o.height===i||(o.width=s,o.height=i),o.ctx2d||(o.ctx2d=o.getContext("2d",{willReadFrequently:!0}));return o.ctx2d.drawImage(e,0,0,a,r,0,0,s,i),e.dbrObjUrl&&URL.revokeObjectURL(e.dbrObjUrl),await this._captureCanvas(o,t)}async _captureCanvas(e,t){if(e.crossOrigin&&"anonymous"!=e.crossOrigin)throw"cors";if([e.width,e.height].includes(0))throw Error("The width or height of the 'canvas' is 0.");const s=e.ctx2d||e.getContext("2d",{willReadFrequently:!0}),i={bytes:Uint8Array.from(s.getImageData(0,0,e.width,e.height).data),width:e.width,height:e.height,stride:4*e.width,format:10};return await this._captureInWorker(i,t)}async _captureVideo(e,t){if(e.crossOrigin&&"anonymous"!=e.crossOrigin)throw"cors";let s,i,a=e.videoWidth,r=e.videoHeight,n=Math.max(a,r);n>this.maxCvsSideLength?(this._compressRate=this.maxCvsSideLength/n,s=Math.round(a*this._compressRate),i=Math.round(r*this._compressRate)):(s=a,i=r),this._canvas||(this._canvas=document.createElement("canvas"));const o=this._canvas;o.width===s&&o.height===i||(o.width=s,o.height=i),o.ctx2d||(o.ctx2d=o.getContext("2d",{willReadFrequently:!0}));return o.ctx2d.drawImage(e,0,0,a,r,0,0,s,i),await this._captureCanvas(o,t)}async _captureInWorker(i,a){const{bytes:n,width:o,height:d,stride:l,format:u}=i;let _=e();const m=new p;return t[_]=async e=>{var t,s;if(!e.success){let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,m.reject(t)}{const a=Date.now();A._onLog&&(A._onLog(`get result time from worker: ${a}`),A._onLog("worker to main time consume: "+(a-e.workerReturnMsgTime)));try{const a=e.captureResult;i.bytes=e.bytes;for(let e of a.items)0!==this._compressRate&&k(e,this._compressRate),e.type===c.CRIT_ORIGINAL_IMAGE?e.imageData=i:e.type===c.CRIT_NORMALIZED_IMAGE?null===(t=r.ddn)||void 0===t||t.handleNormalizedImageResultItem(e):e.type===c.CRIT_PARSED_RESULT&&(null===(s=r.dcp)||void 0===s||s.handleParsedResultItem(e));if(this._dynamsoft)for(let e of this._resultFilterSet)e.onDecodedBarcodesReceived(a.items),e.onRecognizedTextLinesReceived(a.items),e.onDetectedQuadsReceived(a.items),e.onNormalizedImagesReceived(a.items);const n=function(e){const t={barcodeResultItems:[],textLineResultItems:[],detectedQuadResultItems:[],normalizedImageResultItems:[],parsedResultItems:[]};return e.items.forEach((e=>{e.type===c.CRIT_BARCODE?t.barcodeResultItems.push(e):e.type===c.CRIT_TEXT_LINE?t.textLineResultItems.push(e):e.type===c.CRIT_DETECTED_QUAD?t.detectedQuadResultItems.push(e):e.type===c.CRIT_NORMALIZED_IMAGE?t.normalizedImageResultItems.push(e):e.type===c.CRIT_PARSED_RESULT&&t.parsedResultItems.push(e)})),t}(a);if(n.barcodeResultItems.length&&(a.barcodeResultItems=n.barcodeResultItems),n.textLineResultItems.length&&(a.textLineResultItems=n.textLineResultItems),n.detectedQuadResultItems.length&&(a.detectedQuadResultItems=n.detectedQuadResultItems),n.normalizedImageResultItems.length&&(a.normalizedImageResultItems=n.normalizedImageResultItems),n.parsedResultItems.length&&(a.parsedResultItems=n.parsedResultItems),!this._bPauseScan||!this._dynamsoft){const e=a.intermediateResult;if(e){let t=0;for(let s of this._intermediateResultReceiverSet){t++;for(let a of e){if("onTaskResultsReceived"===a.info.callbackName){for(let e of a.intermediateResultUnits)e.originalImageTag=i.tag?i.tag:null;s[a.info.callbackName]&&s[a.info.callbackName]({intermediateResultUnits:a.intermediateResultUnits},a.info)}else s[a.info.callbackName]&&s[a.info.callbackName](a.result,a.info);t===this._intermediateResultReceiverSet.size&&delete a.info.callbackName}}}a&&a.intermediateResult&&delete a.intermediateResult}return this._compressRate=0,m.resolve(a)}catch(e){return m.reject(e)}}},A._onLog&&A._onLog(`send buffer to worker: ${Date.now()}`),s.postMessage({type:"cvr_capture",id:_,instanceID:this._instanceID,body:{bytes:n,width:o,height:d,stride:l,format:u,templateName:a||"",dynamsoft:this._dynamsoft}},[n.buffer]),m}async initSettings(i){return this._checkIsDisposed(),i&&["string","object"].includes(typeof i)?("string"==typeof i?i.startsWith("{")?this._currentSettings=JSON.parse(i):i=await h(i,"text"):"object"==typeof i&&(this._currentSettings=i,i=JSON.stringify(i)),await new Promise(((a,r)=>{let n=e();t[n]=async e=>{if(e.success){const t=JSON.parse(e.response);if(0!==t.exception){let e=new Error(t.description?t.description:"Init Settings Failed.");return e.errorCode=t.exception,r(e)}let s=[],n=JSON.parse(i).CaptureVisionTemplates;for(let e=0;e<n.length;e++){let t=await this.containsTask(n[e].Name);s=s.concat(t)}return await l([...new Set(s)]),this._bNeedOutputOriginalImage=1===this._currentSettings.CaptureVisionTemplates[0].OutputOriginalImage,a(t)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},s.postMessage({type:"cvr_initSettings",id:n,instanceID:this._instanceID,body:{settings:i}})}))):console.error("Invalid template.")}async outputSettings(i){return this._checkIsDisposed(),await new Promise(((a,r)=>{let n=e();t[n]=async e=>{if(e.success){const t=JSON.parse(e.settings);if(0!==t.errorCode){let e=new Error(t.errorString);return e.errorCode=t.errorCode,r(e)}return delete t.errorCode,delete t.errorString,a(t)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},s.postMessage({type:"cvr_outputSettings",id:n,instanceID:this._instanceID,body:{templateName:i||"*"}})}))}async outputSettingsToFile(e,t,s){const i=await this.outputSettings(e),a=new Blob([JSON.stringify(i,null,2,(function(e,t){return t instanceof Array?JSON.stringify(t):t}),2)],{type:"application/json"});if(s){const e=document.createElement("a");e.href=URL.createObjectURL(a),t.endsWith(".json")&&(t=t.replace(".json","")),e.download=`${t}.json`,e.onclick=()=>{setTimeout((()=>{URL.revokeObjectURL(e.href)}),500)},e.click()}return a}async getSimplifiedSettings(i){this._checkIsDisposed(),i||(i=this._currentSettings.CaptureVisionTemplates[0].Name);const a=await this.containsTask(i);return await l(a),await new Promise(((a,r)=>{let n=e();t[n]=async e=>{if(e.success){const t=JSON.parse(e.settings,((e,t)=>g&&"barcodeFormatIds"===e?BigInt(t):t));if(t.minImageCaptureInterval=this._minImageCaptureInterval,0!==t.code){let e=new Error(t.codeString);return e.errorCode=t.errorCode,r(e)}return delete t.code,delete t.codeString,a(t)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},s.postMessage({type:"cvr_getSimplifiedSettings",id:n,instanceID:this._instanceID,body:{templateName:i}})}))}async updateSettings(i,a){this._checkIsDisposed();const r=await this.containsTask(i);return await l(r),await new Promise(((r,n)=>{let o=e();t[o]=async e=>{if(e.success){const t=JSON.parse(e.response);if(a.minImageCaptureInterval&&a.minImageCaptureInterval>=-1&&(this._minImageCaptureInterval=a.minImageCaptureInterval),this._bNeedOutputOriginalImage=e.bNeedOutputOriginalImage,0!==t.exception){let e=new Error(t.description?t.description:"Update Settings Failed.");return e.errorCode=t.exception,n(e)}return this._currentSettings=await this.outputSettings("*"),r(t)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,n(t)}},s.postMessage({type:"cvr_updateSettings",id:o,instanceID:this._instanceID,body:{settings:a,templateName:i}})}))}async resetSettings(){return this._checkIsDisposed(),await new Promise(((i,a)=>{let r=e();t[r]=async e=>{if(e.success){const t=JSON.parse(e.response);if(0!==t.exception){let e=new Error(t.description?t.description:"Reset Settings Failed.");return e.errorCode=t.exception,a(e)}return this._currentSettings=await this.outputSettings("*"),i(t)}{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,a(t)}},s.postMessage({type:"cvr_resetSettings",id:r,instanceID:this._instanceID})}))}getBufferedItemsManager(){return this._bufferdItemsManager||(this._bufferdItemsManager=new v(this)),this._bufferdItemsManager}getIntermediateResultManager(e){if(this._checkIsDisposed(),!e&&0!==d.bSupportIRTModule)throw new Error("The current license does not support the use of intermediate results.");return this._intermediateResultManager||(this._intermediateResultManager=new E(this)),this._intermediateResultManager}contains(e,t){return function(e,t){let s=t.x,i=t.y,a=e[0].x,r=e[0].y,n=e[1].x,o=e[1].y,c=e[2].x,d=e[2].y,l=e[3].x,u=e[3].y,_=R(s,i,a,r,n,o),m=R(s,i,n,o,c,d),h=R(s,i,c,d,l,u),g=R(s,i,l,u,a,r);function R(e,t,s,i,a,r){return(e-s)*(r-i)-(t-i)*(a-s)}return _>=0&&m>=0&&h>=0&&g>=0||_<=0&&m<=0&&h<=0&&g<=0}(e,t)}async parseRequiredResources(i){return this._checkIsDisposed(),await new Promise(((a,r)=>{let n=e();t[n]=async e=>{if(e.success)return a(JSON.parse(e.resources));{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},s.postMessage({type:"cvr_parseRequiredResources",id:n,instanceID:this._instanceID,body:{templateName:i}})}))}async dispose(){this._checkIsDisposed(),this._promiseStartScan&&this.stopCapturing(),this._isa=null,this._resultReceiverSet.clear(),this._isaStateListenerSet.clear(),this._resultFilterSet.clear(),this.bDestroyed=!0;let i=e();t[i]=e=>{if(!e.success){let t=new Error(e.message);throw t.stack=e.stack+"\n"+t.stack,t}},s.postMessage({type:"cvr_dispose",id:i,instanceID:this._instanceID})}async _enableResultCrossVerification(i){return this._checkIsDisposed(),await new Promise(((a,r)=>{let n=e();t[n]=async e=>{if(e.success)return a(e.result);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},s.postMessage({type:"cvr_enableResultCrossVerification",id:n,instanceID:this._instanceID,body:{verificationEnabled:i}})}))}async _enableResultDeduplication(i){return this._checkIsDisposed(),await new Promise(((a,r)=>{let n=e();t[n]=async e=>{if(e.success)return a(e.result);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},s.postMessage({type:"cvr_enableResultDeduplication",id:n,instanceID:this._instanceID,body:{duplicateFilterEnabled:i}})}))}async _setDuplicateForgetTime(i){return this._checkIsDisposed(),await new Promise(((a,r)=>{let n=e();t[n]=async e=>{if(e.success)return a(e.result);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},s.postMessage({type:"cvr_setDuplicateForgetTime",id:n,instanceID:this._instanceID,body:{duplicateForgetTime:i}})}))}async _getDuplicateForgetTime(i){return this._checkIsDisposed(),await new Promise(((a,r)=>{let n=e();t[n]=async e=>{if(e.success)return a(e.time);{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,r(t)}},s.postMessage({type:"cvr_getDuplicateForgetTime",id:n,instanceID:this._instanceID,body:{type:i}})}))}async _setThresholdValue(i,a,r){return await l("ddn"),await new Promise(((n,o)=>{let c=e();t[c]=async e=>{if(e.success)return n();{let t=new Error(e.message);return t.stack=e.stack+"\n"+t.stack,o(t)}},s.postMessage({type:"ddn_setThresholdValue",id:c,instanceID:this._instanceID,body:{threshold:i,leftLimit:a,rightLimit:r}})}))}_checkIsDisposed(){if(this.disposed)throw new Error('"CaptureVisionRouter" instance has been disposed')}}class M{constructor(){this.onCapturedResultReceived=null,this.onOriginalImageResultReceived=null}}class N{constructor(){this._observedResultUnitTypes=R.IRUT_ALL,this._observedTaskMap=new Map,this._parameters={setObservedResultUnitTypes:e=>{this._observedResultUnitTypes=e},getObservedResultUnitTypes:()=>this._observedResultUnitTypes,isResultUnitTypeObserved:e=>!!(e&this._observedResultUnitTypes),addObservedTask:e=>{this._observedTaskMap.set(e,!0)},removeObservedTask:e=>{this._observedTaskMap.set(e,!1)},isTaskObserved:e=>0===this._observedTaskMap.size||!!this._observedTaskMap.get(e)},this.onTaskResultsReceived=null,this.onPredetectedRegionsReceived=null,this.onColourImageUnitReceived=null,this.onScaledDownColourImageUnitReceived=null,this.onGrayscaleImageUnitReceived=null,this.onTransformedGrayscaleImageUnitReceived=null,this.onEnhancedGrayscaleImageUnitReceived=null,this.onBinaryImageUnitReceived=null,this.onTextureDetectionResultUnitReceived=null,this.onTextureRemovedGrayscaleImageUnitReceived=null,this.onTextureRemovedBinaryImageUnitReceived=null,this.onContoursUnitReceived=null,this.onLineSegmentsUnitReceived=null,this.onTextZonesUnitReceived=null,this.onTextRemovedBinaryImageUnitReceived=null,this.onShortLinesUnitReceived=null}getObservationParameters(){return this._parameters}}export{A as CaptureVisionRouter,O as CaptureVisionRouterModule,M as CapturedResultReceiver,L as EnumImageSourceState,E as IntermediateResultManager,N as IntermediateResultReceiver};
